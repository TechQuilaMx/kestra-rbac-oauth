name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'dev'
        type: string
      tag:
        description: 'Docker image tag (e.g., v1.0.0, latest, dev)'
        required: true
        default: 'latest'
        type: string
      push_image:
        description: 'Push image to registry'
        required: true
        default: true
        type: boolean
      install_plugins:
        description: 'Install Kestra plugins from .plugins file'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for attestation
      attestations: write  # Required for attestation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: inputs.push_image
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare tags
        id: prep
        run: |
          TAG="${{ inputs.tag }}"
          IMAGE_RAW="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          IMAGE=$(echo "${IMAGE_RAW}" | tr '[:upper:]' '[:lower:]')
          echo "tags=${IMAGE}:${TAG}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Building image: ${IMAGE}:${TAG}"

      - name: Parse plugins from .plugins file
        id: plugins
        if: ${{ inputs.install_plugins }}
        run: |
          # Extract all uncommented plugin lines from .plugins file
          # Format in file: Repository:GroupId:ArtifactId:Version
          # Extract only: GroupId:ArtifactId:Version (skip first field)
          PLUGINS=$(grep -v '^#' .plugins | grep -v '^$' | cut -d: -f2- | tr '\n' ' ')
          echo "plugins=${PLUGINS}" >> $GITHUB_OUTPUT
          echo "Found plugins: ${PLUGINS}"

      - name: Skip plugin installation
        if: ${{ !inputs.install_plugins }}
        run: |
          echo "â­ï¸  Skipping plugin installation (install_plugins=false)"

      - name: Build and push Docker image
        id: build-and-push  # Added id to reference outputs
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.rbac
          push: ${{ inputs.push_image }}
          tags: ${{ steps.prep.outputs.tags }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}
          build-args: |
            APT_PACKAGES=python3 python-is-python3 python3-pip curl jattach
            PYTHON_LIBRARIES=kestra
            KESTRA_PLUGINS=${{ inputs.install_plugins && steps.plugins.outputs.plugins || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Generate artifact attestation
        if: inputs.push_image
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ steps.prep.outputs.image }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

      - name: Output image details
        run: |
          echo "âœ… Build completed successfully!"
          echo "ğŸ³ Image: ${{ steps.prep.outputs.tags }}"
          echo "ğŸ“¦ Branch: ${{ inputs.branch }}"
          echo "ğŸ·ï¸  Tag: ${{ inputs.tag }}"
          echo "ğŸ“¤ Pushed: ${{ inputs.push_image }}"
          echo "ğŸ”Œ Plugins installed: ${{ inputs.install_plugins }}"