# Multi-stage Dockerfile for building Kestra from source
FROM eclipse-temurin:21-jdk-jammy AS builder

# Install Node.js for building the UI
RUN apt-get update && \
    apt-get install -y curl git && \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy Gradle wrapper and properties first for better caching
COPY --chmod=755 gradlew ./
COPY gradlew.bat gradle.properties settings.gradle build.gradle ./
COPY gradle ./gradle

# Copy docker-entrypoint.sh
COPY --chown=kestra:kestra --chmod=755 docker/app/docker-entrypoint.sh /docker-entrypoint.sh

# Download dependencies (this layer will be cached)
RUN ./gradlew dependencies --no-daemon || true

# Copy all source code
COPY . .

# Restore gradlew permissions after COPY . . overwrites it
RUN chmod +x ./gradlew

# Build the executable JAR (includes UI build)
RUN ./gradlew executableJar --no-daemon --info

# Runtime stage
FROM eclipse-temurin:21-jre-jammy

ARG KESTRA_PLUGINS=""
ARG APT_PACKAGES=""
ARG PYTHON_LIBRARIES=""

WORKDIR /app

RUN groupadd kestra && \
    useradd -m -g kestra kestra

# Create config directory and copy application configuration
RUN mkdir -p /app/confs
COPY --chown=kestra:kestra --from=builder /build/cli/src/main/resources/application.yml /app/confs/application.yml

# Copy docker configuration files (scripts and utilities)
COPY --chown=kestra:kestra docker /

# Copy docker entrypoint script to PATH for easy access
COPY --chown=kestra:kestra --chmod=755 docker/app/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh

# Copy the built executable from builder stage
COPY --chown=kestra:kestra --from=builder /build/build/executable/kestra-* /app/kestra

RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends python3 python-is-python3 python3-pip curl && \
    if [ -n "${APT_PACKAGES}" ]; then apt-get install -y --no-install-recommends ${APT_PACKAGES}; fi && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/* && \
    curl -LsSf https://astral.sh/uv/0.6.17/install.sh | sh && mv /root/.local/bin/uv /bin && mv /root/.local/bin/uvx /bin && \
    chmod +x /app/kestra && \
    if [ -n "${KESTRA_PLUGINS}" ]; then /app/kestra plugins install ${KESTRA_PLUGINS} && rm -rf /tmp/*; fi && \
    if [ -n "${PYTHON_LIBRARIES}" ]; then uv pip install --system ${PYTHON_LIBRARIES}; fi && \
    chown -R kestra:kestra /app

USER kestra

ENTRYPOINT ["docker-entrypoint.sh"]

CMD ["--help"]